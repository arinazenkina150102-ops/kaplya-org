<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Оргструктура — Капля</title>

  <!-- Подключаем Bootstrap -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Дополнительные стили -->
  <style>
    /* Цвета */
    :root {
      --bg-color: #f4f7fc;  /* Светлый фон */
      --primary-color: #003d73;  /* Синий для основного */
      --secondary-color: #f0f4f8;  /* Очень светлый фон */
      --text-color: #333;  /* Тёмный текст */
      --accent-color: #ff5c5c;  /* Красный для акцентов */
      --gold-color: #d6a13f;  /* Золотистый для выделений */
      --button-color: #003d73;  /* Синий для кнопок */
    }

    /* Основной фон и шрифты */
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Arial', sans-serif;
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      text-align: center;
    }

    footer {
      background-color: var(--primary-color);
      color: white;
      text-align: center;
      padding: 10px;
    }

    .search-section {
      margin-top: 20px;
    }

    .search-section input {
      width: 70%;
    }

    .search-section button {
      width: 20%;
    }

    .card {
      margin-bottom: 20px;
    }

    .card .card-body {
      padding: 20px;
    }

    .card .card-title {
      color: var(--primary-color);
    }

    .card .card-text {
      color: var(--text-color);
    }

    .card .tag {
      background-color: var(--gold-color);
      color: var(--secondary-color);
      padding: 5px 10px;
      border-radius: 10px;
    }

    button {
      background-color: var(--button-color);
      color: var(--secondary-color);
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: var(--accent-color);
    }

    #clearSearch {
      background-color: #dc3545;
      color: var(--secondary-color);
    }
    #clearSearch:hover {
      background-color: #c82333;
    }

  </style>
</head>

<body>

  <!-- Навигация -->
  <header>
    <h1>Оргструктура компании</h1>
  </header>

  <main class="container">
    <!-- Поиск -->
    <div class="search-section">
      <div class="input-group">
        <input type="search" id="search" class="form-control" placeholder="Поиск: отдел, ФИО, должность, вопросы..." />
        <div class="input-group-append">
          <button id="clearSearch" class="btn btn-danger">Очистить</button>
        </div>
      </div>
    </div>

    <!-- Контейнер для отображения данных -->
    <section id="view" class="row">
      <!-- Карточки для отображения данных -->
    </section>
  </main>

  <!-- Подключаем JavaScript -->
  <script>
    // Твой JS код
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT0X2z7-H5MM3arEVrYh0wuBiNfpphFa3ebyXu8KouT48l2egq-kctEXDCFtUbGVg/pub?gid=1412005436&single=true&output=csv";

    const viewEl = document.getElementById("view");
    const crumbsEl = document.getElementById("crumbs");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const searchEl = document.getElementById("search");
    const clearSearchBtn = document.getElementById("clearSearch");

    let DATA = [];

    function showError(msg){
      viewEl.innerHTML = `<div class="empty"><b>Ошибка</b><br><br>${escapeHtml(msg)}</div>`;
    }

    window.addEventListener("error", (e) => {
      showError(e.message || "Неизвестная ошибка JS");
    });

    function setHash(path){
      const clean = String(path || "").replace(/^#/, "").replace(/^\/+/, "");
      location.hash = "/" + clean;
    }

    function parseHash(){
      const h = location.hash ? location.hash.slice(1) : "/departments"; 
      return (h || "/departments")
        .split("/")
        .filter(Boolean)
        .map(decodeURIComponent);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function splitTopics(s){
      return String(s||"")
        .split(",")
        .map(x=>x.trim())
        .filter(Boolean)
        .slice(0, 20);
    }

    function slug(s){
      return String(s||"").toLowerCase()
        .replace(/ё/g,"е")
        .replace(/[^a-zа-я0-9]+/g,"-")
        .replace(/^-+|-+$/g,"")
        .slice(0, 80) || "item";
    }

    function looksLikePhone(s){
      const t = String(s||"").replace(/\u00A0/g," ").trim();
      return t && /^[0-9\s,+\-()]+$/.test(t) && !/[a-zа-я]/i.test(t);
    }

    function groupByDept(rows){
      const map = new Map();

      for(const r of rows){
        const rawDept = (r["Отдел"] || "").trim();
        if(!rawDept) continue;

        if (looksLikePhone(rawDept)) continue;

        const deptName = rawDept;
        const sub = (r["Подразделение"] || "").trim();
        const key = deptName;

        if(!map.has(key)) map.set(key, { id: slug(key), name: key, description: "", people: []});
        const node = map.get(key);

        node.people.push({
          id: slug((r["ФИО"]||"") + "_" + (r["Должность"]||"")),
          fullName: (r["ФИО"]||"").trim(),
          role: (r["Должность"]||"").trim(),
          email: (r["Email"]||"").trim(),
          phoneCorp: (r["Телефон_корп"] || "").toString().replace(/\D/g, ''), 
          phonePersonal: (r["Телефон_личный"] || "").toString().replace(/\D/g, ''),
          extension: (r["Добавочный номер"] || "").trim(),
          location: (r["Локация"] || "").trim() || "Не указано", 
          topics: splitTopics(r["Вопросы"] || "Не указано"),
          subunit: sub
        });
      }

      return Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'ru'));
    }

    async function loadCSV(){
      try{
        if(!CSV_URL) { showError("Не указана CSV_URL"); return; }
        const res = await fetch(CSV_URL, { cache: "no-store" });
        const text = await res.text();
        const rows = parseCSV(text);

        DATA = groupByDept(rows);
        render();
      }catch(err){
        showError(err?.message || String(err));
      }
    }

    function parseCSV(text){
      const rows=[];
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.length);
      if(!lines.length) return rows;

      const header = splitCSVLine(lines[0]).map(h=>h.trim());
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj={};
        header.forEach((h,idx)=>obj[h]=cols[idx] ?? "");
        rows.push(obj);
      }
      return rows;
    }

    function splitCSVLine(line){
      const out=[]; let cur=""; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ = !inQ;
        } else if(ch === "," && !inQ){
          out.push(cur); cur="";
        } else {
          cur+=ch;
        }
      }
      out.push(cur);
      return out;
    }

    function findDeptByHashId(deptHashId){ return DATA.find(d => d.id === deptHashId); }
    function findPerson(deptHashId, personId){
      const dept = findDeptByHashId(deptHashId);
      if(!dept) return null;
      return dept.people.find(p => p.id === personId);
    }

    function renderDepartments(filter=""){
      const q = filter.trim().toLowerCase();
      const list = DATA.filter(d => {
        const deptText = `${d.name} ${d.description}`.toLowerCase();
        const peopleText = d.people.map(p => `${p.fullName} ${p.role} ${(p.topics||[]).join(" ")} ${p.subunit||""}`).join(" ").toLowerCase();
        return !q || deptText.includes(q) || peopleText.includes(q);
      });

      crumbsEl.textContent = "/ Отделы";
      backBtn.style.display = "none";

      if(list.length === 0){
        viewEl.innerHTML = `<div class="empty">Ничего не найдено. Попробуй другой запрос.</div>`;
        return;
      }

      viewEl.innerHTML = `
        <div class="grid">
          ${list.map(d => `
            <div class="card" onclick="setHash('dept/${encodeURIComponent(d.id)}')">
              <p class="title">${escapeHtml(d.name)}</p>
              <p class="sub">${escapeHtml(d.description || " ")}</p>
              <span class="tag">Сотрудников: ${d.people.length}</span>
            </div>
          `).join("")}
        </div>
      `;
    }

    function render(){
      const parts = parseHash();
      const q = searchEl.value || "";

      if(parts.length === 1 && parts[0] === "departments"){ renderDepartments(q); return; }
      if(parts.length === 2 && parts[0] === "dept"){ renderDept(parts[1], q); return; }
      if(parts.length === 3 && parts[0] === "person"){ renderPerson(parts[1], parts[2]); return; }

      setHash("departments");
    }

    homeBtn.onclick = () => setHash("departments");
    searchEl.addEventListener("input", () => render());
    clearSearchBtn.onclick = () => { searchEl.value = ""; render(); };
    window.addEventListener("hashchange", () => render());

    if(!location.hash) setHash("departments");
    loadCSV();
  </script>
</body>
</html>


